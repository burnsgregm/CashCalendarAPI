<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Calendar</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.7.2/dist/axios.min.js"></script>

    <style>
        /* --- Basic Setup --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f6;
            margin: 0;
            padding: 24px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        /* --- Login Screen --- */
        #login-container {
            text-align: center;
            padding: 40px;
        }
        #login-btn {
            background-color: #4285F4;
            font-size: 1.2em;
            padding: 12px 24px;
        }
        #login-btn:hover { background-color: #357ae8; }
        
        /* --- Main App (Hidden by default) --- */
        #main-app { display: none; }
        
        /* --- Legend --- */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .legend-item { font-size: 0.9em; }
        .legend-item .actual { font-weight: 600; }
        .legend-item .estimated { font-style: italic; }
        .legend-item .credits { color: #1E88E5; }
        .legend-item .debits { color: #D32F2F; }
        
        /* --- Calendar --- */
        #calendar {
            max-height: 80vh;
        }
        .fc-event-title {
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
            padding: 2px;
        }
        
        /* --- Modal (Pop-up) Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px; right: 20px;
            font-size: 2.5em;
            font-weight: 200;
            line-height: 1;
            color: #aaa;
            cursor: pointer;
            border: none;
            background: none;
        }
        .modal-close-btn:hover { color: #333; }
        .modal-hidden { display: none; }
        
        /* --- Form & UI Elements --- */
        input[type="text"], input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
        }
        button:hover { background-color: #0056b3; }
        .btn-danger { background-color: #D32F2F; }
        .btn-danger:hover { background-color: #b71c1c; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-full { width: 100%; }
        .btn-small { padding: 5px 10px; font-size: 0.8em; }
        .flex-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #333;
        }
        .toggle-group { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; }
        
        /* --- Day View Styles --- */
        .day-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 16px;
            margin-bottom: 16px;
        }
        .day-header-metrics {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .day-header-metrics div { padding: 0 10px; }
        .day-header-metrics .balance { font-size: 1.5em; }
        .day-header-metrics .balance .actual { font-weight: 600; }
        .day-header-metrics .balance .estimated { font-style: italic; }
        .day-header-metrics .balance.negative { color: #D32F2F; }
        .day-header-metrics .label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
        }
        .day-header-metrics .credits { font-size: 1.2em; color: #1E88E5; }
        .day-header-metrics .debits { font-size: 1.2em; color: #D32F2F; }

        .tx-list { list-style: none; padding: 0; }
        .tx-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .tx-item .desc { font-weight: 500; }
        .tx-item .category { font-size: 0.9em; color: #666; margin-left: 8px; }
        .tx-item .amount { font-size: 1.1em; font-weight: 500; }
        .tx-item .amount.credit { color: #1E88E5; }
        .tx-item .amount.debit { color: #D32F2F; }
        .tx-item .status { font-size: 0.9em; color: #666; margin-left: 12px; }
        .tx-item .actions { display: flex; gap: 8px; }

        hr { border: none; border-top: 1px solid #eee; margin: 20px 0; }

    </style>
</head>
<body>

    <div id="login-container" class="container">
        <h1>Welcome to the Cash Calendar</h1>
        <p>Please log in with your Google account to continue.</p>
        <br>
        <button id="login-btn">Login with Google</button>
    </div>

    <div id="main-app" class="container">
        <h1 id="app-title">Financial Calendar</h1>
        <p id="app-subtitle">Welcome! Loading your financial data...</p>

        <button id="open-settings-btn" style="float: right; margin-bottom: 10px;" class="btn-secondary">Settings</button>
        <button id="logout-btn" style="float: right; margin-bottom: 10px; margin-right: 10px;" class="btn-danger">Logout</button>


        <div class="legend">
            <div class="legend-item"><span class="actual">$123.45</span>: <b>Actual</b> Balance</div>
            <div class="legend-item"><span class="estimated">$123.45</span>: <i>Estimated</i> Balance</div>
            <div class="legend-item"><span class="credits">+$123.45</span>: Total Credits</div>
            <div class="legend-item"><span class="debits">-$123.45</span>: Total Debits</div>
        </div>

        <div id="calendar"></div>
    </div>

    <div id="day-view-modal" class="modal-overlay modal-hidden">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="day-view-modal">&times;</button>
            <h2 id="day-view-title">Day Details</h2>
            
            <div class="day-header">
                <div class="day-header-metrics">
                    <div>
                        <div class="label">Balance</div>
                        <div id="day-view-balance" class="balance">$0.00</div>
                    </div>
                    <div>
                        <div class="label">Total Credits</div>
                        <div id="day-view-credits" class="credits">+$0.00</div>
                    </div>
                    <div>
                        <div class="label">Total Debits</div>
                        <div id="day-view-debits" class="debits">-$0.00</div>
                    </div>
                </div>
            </div>

            <h3>Transactions</h3>
            <ul id="day-view-tx-list" class="tx-list">
                </ul>
            <div id="day-view-no-tx" style="display: none; color: #666;">No transactions for this day.</div>
            
            <hr>
            <button id="open-add-tx-btn" class="btn-full">Add New Transaction...</button>
        </div>
    </div>
    
    <div id="tx-modal" class="modal-overlay modal-hidden">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="tx-modal">&times;</button>
            <h2 id="tx-modal-title">Add New Transaction</h2>
            
            <form id="tx-form">
                <input type="hidden" id="tx-id">
                
                <div class="flex-grid">
                    <div class="form-group">
                        <label for="tx-date">Date</label>
                        <input type="date" id="tx-date" required>
                    </div>
                    <div class="form-group">
                        <label for="tx-description">Description</label>
                        <input type="text" id="tx-description" placeholder="e.g., Paycheck, Netflix">
                    </div>
                </div>
                <div class="flex-grid">
                    <div class="form-group">
                        <label for="tx-amount">Amount</label>
                        <input type="number" id="tx-amount" step="0.01" placeholder="-25.50" required>
                    </div>
                    <div class="form-group">
                        <label for="tx-category">Category</label>
                        <select id="tx-category"></select>
                    </div>
                </div>
                
                <div class="toggle-group">
                    <input type="checkbox" id="tx-confirmed" style="width: auto;">
                    <label for="tx-confirmed">This is a confirmed (actual) amount</label>
                </div>
                
                <hr>
                
                <div id="schedule-options-container">
                    <div class="toggle-group">
                        <input type="checkbox" id="tx-schedule-toggle" style="width: auto;">
                        <label for="tx-schedule-toggle">Schedule as a recurring transaction?</label>
                    </div>
                    
                    <div id="tx-schedule-options" class="modal-hidden">
                        <div class="flex-grid">
                            <div class="form-group">
                                <label for="tx-frequency">Frequency</label>
                                <select id="tx-frequency">
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="bi-weekly">Bi-Weekly (Every 2 Weeks)</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="bi-monthly">Bi-Monthly (Every 2 Months)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tx-end-date">End Date (Optional)</label>
                                <input type="date" id="tx-end-date">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" id="save-tx-btn" class="btn-full">Save Transaction</button>
            </form>
        </div>
    </div>
    
    <div id="settings-modal" class="modal-overlay modal-hidden">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="settings-modal">&times;</button>
            <h2>Settings</h2>
            
            <form id="settings-form">
                <h3>Account Setup</h3>
                <p>Set your starting balance and date.</p>
                <div class="flex-grid">
                    <div class="form-group">
                        <label for="settings-start-date">Start Date</label>
                        <input type="date" id="settings-start-date" required>
                    </div>
                    <div class="form-group">
                        <label for="settings-start-balance">Starting Balance</label>
                        <input type="number" id="settings-start-balance" step="0.01" required>
                    </div>
                </div>
                <button type="submit" id="save-settings-btn" class="btn-full">Save Settings</button>
            </form>
            
            <hr>
            
            <h3>Manage Scheduled Transactions</h3>
            <ul id="schedule-list" class="tx-list">
                </ul>
        </div>
    </div>
    
    <div id="category-modal" class="modal-overlay modal-hidden">
        <div class="modal-content">
            <button class="modal-close-btn" data-modal-id="category-modal">&times;</button>
            <h2>Manage Categories</h2>
            
            <ul id="category-list-manager" class="tx-list">
                </ul>
            <form id="add-category-form" style="display: flex; gap: 10px; margin-top: 16px;">
                <input type="text" id="new-cat-name" placeholder="New category name" style="margin: 0;">
                <select id="new-cat-type" style="margin: 0;">
                    <option value="debit">Debit</option>
                    <option value="credit">Credit</option>
                </select>
                <button type="submit" class="btn-secondary">Add</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- CONFIGURATION ---
            // FOR LOCAL DEV: "http://127.0.0.1:5000"
            // FOR PRODUCTION: "https://your-api-name.onrender.com"
            const API_BASE_URL = "http://127.0.0.1:5000"; 
            
            const API_URL = `${API_BASE_URL}/api`;
            const LOGIN_URL = `${API_BASE_URL}/api/login`;

            // --- UI ELEMENTS ---
            const calendarEl = document.getElementById('calendar');
            const loginContainer = document.getElementById('login-container');
            const mainAppContainer = document.getElementById('main-app');
            const appSubtitle = document.getElementById('app-subtitle');
            let fullCalendar;

            // --- APP STATE ---
            const appState = {
                jwtToken: null,
                categories: [],
                settings: {},
            };
            
            // --- MODAL & DIALOG HELPER FUNCTIONS ---
            const openModal = (modalId) => document.getElementById(modalId).classList.remove('modal-hidden');
            const closeModal = (modalId) => document.getElementById(modalId).classList.add('modal-hidden');
            
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.dataset.modalId));
            });
            document.getElementById('open-settings-btn').addEventListener('click', openSettingsDialog);
            document.getElementById('open-add-tx-btn').addEventListener('click', () => {
                closeModal('day-view-modal');
                openAddTxDialog(document.getElementById('tx-date').value);
            });
            document.getElementById('logout-btn').addEventListener('click', logout);

            // --- FORMATTING HELPERS ---
            const formatCurrency = (val) => {
                return parseFloat(val || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            };
            
            // --- API FUNCTIONS ---
            // Create an Axios instance that will automatically include our JWT token
            const api = axios.create();
            api.interceptors.request.use(config => {
                if (appState.jwtToken) {
                    config.headers.Authorization = `Bearer ${appState.jwtToken}`;
                }
                return config;
            }, error => {
                return Promise.reject(error);
            });

            async function fetchSettings() {
                try {
                    const response = await api.get(`${API_URL}/settings`);
                    appState.settings = response.data;
                    document.getElementById('settings-start-date').value = appState.settings.start_date;
                    document.getElementById('settings-start-balance').value = appState.settings.start_balance;
                } catch (e) { console.error("Error fetching settings:", e); }
            }
            
            async function fetchCategories() {
                try {
                    const response = await api.get(`${API_URL}/categories`);
                    appState.categories = response.data;
                    populateCategoryDropdown(response.data);
                    populateCategoryManagerList(response.data);
                } catch (e) { console.error("Error fetching categories:", e); }
            }

            // --- UI POPULATION FUNCTIONS ---
            function populateCategoryDropdown(categories) {
                const select = document.getElementById('tx-category');
                select.innerHTML = '<option value="">-- No Category --</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.category_id}">${cat.name} (${cat.type})</option>`;
                });
                select.innerHTML += '<option value="--MANAGE--" style="font-weight: bold; color: #007bff;">-- Manage Categories --</option>';
            }

            function populateCategoryManagerList(categories) {
                const list = document.getElementById('category-list-manager');
                list.innerHTML = '';
                if (categories.length === 0) {
                    list.innerHTML = '<li style="color: #666;">No categories created yet.</li>';
                    return;
                }
                categories.forEach(cat => {
                    const li = document.createElement('li');
                    li.className = 'tx-item';
                    li.innerHTML = `
                        <div>
                            <span class="desc">${cat.name}</span>
                            <span class="category">(${cat.type})</span>
                        </div>
                        <button class="btn-danger btn-small" data-cat-id="${cat.category_id}">Delete</button>
                    `;
                    list.appendChild(li);
                });
            }
            
            async function populateScheduledList() {
                const list = document.getElementById('schedule-list');
                try {
                    const response = await api.get(`${API_URL}/schedules`);
                    const schedules = response.data;
                    list.innerHTML = '';
                    if (schedules.length === 0) {
                        list.innerHTML = '<li style="color: #666;">No scheduled transactions.</li>';
                        return;
                    }
                    schedules.forEach(s => {
                        const li = document.createElement('li');
                        li.className = 'tx-item';
                        li.innerHTML = `
                            <div>
                                <span class="desc">${s.description || 'N/A'}</span>
                                <span class="category">(${formatCurrency(s.amount)} ${s.frequency})</span>
                            </div>
                            <button class="btn-danger btn-small" data-schedule-id="${s.schedule_id}">Delete</button>
                        `;
                        list.appendChild(li);
                    });
                } catch (e) {
                    console.error("Error fetching schedules:", e);
                    list.innerHTML = '<li style="color: red;">Error loading schedules.</li>';
                }
            }

            // --- DIALOG OPEN/CLOSE LOGIC ---
            
            async function openDayView(dateStr) {
                document.getElementById('day-view-title').innerText = `Details for ${dateStr}`;
                document.getElementById('tx-date').value = dateStr;
                
                try {
                    const response = await api.get(`${API_URL}/transactions/${dateStr}`);
                    const transactions = response.data;
                    
                    const calendarEvent = fullCalendar.getEvents().find(e => e.startStr === dateStr);
                    const props = calendarEvent ? calendarEvent.extendedProps : { balance: 0, credits: 0, debits: 0, is_actual: true };

                    const balanceEl = document.getElementById('day-view-balance');
                    balanceEl.innerText = formatCurrency(props.balance);
                    balanceEl.className = `balance ${props.balance < 0 ? 'negative' : ''} ${props.is_actual ? 'actual' : 'estimated'}`;
                    
                    document.getElementById('day-view-credits').innerText = `+${formatCurrency(props.credits)}`;
                    document.getElementById('day-view-debits').innerText = `${formatCurrency(props.debits)}`;
                    
                    const listEl = document.getElementById('day-view-tx-list');
                    const noTxEl = document.getElementById('day-view-no-tx');
                    listEl.innerHTML = '';
                    
                    if (transactions.length === 0) {
                        noTxEl.style.display = 'block';
                    } else {
                        noTxEl.style.display = 'none';
                        transactions.forEach(tx => {
                            const li = document.createElement('li');
                            li.className = 'tx-item';
                            li.innerHTML = `
                                <div>
                                    <span class="desc">${tx.description || 'N/A'}</span>
                                    ${tx.name ? `<span class="category">(${tx.name})</span>` : ''}
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <span class="amount ${tx.amount > 0 ? 'credit' : 'debit'}">${formatCurrency(tx.amount)}</span>
                                    <span class="status">${tx.is_confirmed ? '✅' : '⌛'}</span>
                                    <div class="actions">
                                        <button class="btn-secondary btn-small" data-tx-id-edit="${tx.transaction_id}">Edit</button>
                                        <button class="btn-danger btn-small" data-tx-id-del="${tx.transaction_id}">Delete</button>
                                    </div>
                                </div>
                            `;
                            listEl.appendChild(li);
                        });
                    }
                    
                    openModal('day-view-modal');
                } catch (e) {
                    console.error("Error fetching day transactions:", e);
                    alert("Error loading day details.");
                }
            }
            
            function openAddTxDialog(dateStr) {
                document.getElementById('tx-form').reset();
                document.getElementById('tx-modal-title').innerText = "Add New Transaction";
                document.getElementById('tx-id').value = ""; // Clear any edit ID
                document.getElementById('tx-date').value = dateStr;
                document.getElementById('tx-confirmed').checked = true;
                document.getElementById('schedule-options-container').style.display = 'block';
                document.getElementById('tx-schedule-options').classList.add('modal-hidden');
                openModal('tx-modal');
            }
            
            async function openEditTxDialog(txId) {
                try {
                    const response = await api.get(`${API_URL}/transaction/${txId}`);
                    const tx = response.data;
                    
                    document.getElementById('tx-form').reset();
                    document.getElementById('tx-modal-title').innerText = "Edit Transaction";
                    
                    document.getElementById('tx-id').value = tx.transaction_id;
                    document.getElementById('tx-date').value = tx.date;
                    document.getElementById('tx-description').value = tx.description;
                    document.getElementById('tx-amount').value = tx.amount;
                    document.getElementById('tx-category').value = tx.category_id || "";
                    document.getElementById('tx-confirmed').checked = tx.is_confirmed;
                    
                    document.getElementById('schedule-options-container').style.display = 'none';
                    document.getElementById('tx-schedule-toggle').checked = false;
                    
                    closeModal('day-view-modal');
                    openModal('tx-modal');
                    
                } catch (e) {
                    console.error("Error fetching transaction for edit:", e);
                    alert("Error loading transaction details.");
                }
            }
            
            async function openSettingsDialog() {
                await Promise.all([fetchSettings(), fetchCategories(), populateScheduledList()]);
                openModal('settings-modal');
            }

            async function openManageCategoriesDialog() {
                await fetchCategories();
                openModal('category-modal');
            }
            
            // --- EVENT HANDLERS ---
            
            document.getElementById('login-btn').addEventListener('click', () => {
                window.location.href = LOGIN_URL;
            });
            
            function logout() {
                localStorage.removeItem('jwtToken');
                appState.jwtToken = null;
                showLoginScreen();
            }

            // Handle "Manage Categories" selection from dropdown
            document.getElementById('tx-category').addEventListener('change', (e) => {
                if (e.target.value === '--MANAGE--') {
                    e.target.value = ""; 
                    closeModal('tx-modal');
                    openManageCategoriesDialog();
                }
            });
            
            // Toggle schedule options in add-tx modal
            document.getElementById('tx-schedule-toggle').addEventListener('change', (e) => {
                document.getElementById('tx-schedule-options').classList.toggle('modal-hidden', !e.target.checked);
            });
            
            // Handle Add/Edit Transaction form submission
            document.getElementById('tx-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const txId = document.getElementById('tx-id').value;
                const isEdit = !!txId;
                const isScheduled = document.getElementById('tx-schedule-toggle').checked;
                
                const data = {
                    date: document.getElementById('tx-date').value,
                    description: document.getElementById('tx-description').value,
                    amount: parseFloat(document.getElementById('tx-amount').value),
                    category_id: document.getElementById('tx-category').value || null,
                };
                
                try {
                    if (isEdit) {
                        data.is_confirmed = document.getElementById('tx-confirmed').checked ? 1 : 0;
                        await api.put(`${API_URL}/transactions/${txId}`, data);
                    } else if (isScheduled) {
                        data.frequency = document.getElementById('tx-frequency').value;
                        data.start_date = data.date;
                        data.end_date = document.getElementById('tx-end-date').value || null;
                        await api.post(`${API_URL}/schedules`, data);
                    } else {
                        data.is_confirmed = document.getElementById('tx-confirmed').checked ? 1 : 0;
                        await api.post(`${API_URL}/transactions`, data);
                    }
                    
                    closeModal('tx-modal');
                    fullCalendar.refetchEvents(); // Reload all calendar data
                } catch (e) {
                    console.error("Error saving transaction:", e);
                    alert("Error saving: " + e.response?.data?.error || e.message);
                }
            });

            // Handle transaction Edit/Delete in Day View
            document.getElementById('day-view-tx-list').addEventListener('click', async (e) => {
                const delBtn = e.target.closest('[data-tx-id-del]');
                const editBtn = e.target.closest('[data-tx-id-edit]');
                
                if (delBtn) {
                    const txId = delBtn.dataset.txIdDel;
                    if (confirm("Are you sure you want to delete this transaction?")) {
                        try {
                            await api.delete(`${API_URL}/transactions/${txId}`);
                            closeModal('day-view-modal');
                            fullCalendar.refetchEvents(); // Reload all calendar data
                        } catch (e) {
                            console.error("Error deleting transaction:", e);
                            alert("Error deleting: " + e.response?.data?.error || e.message);
                        }
                    }
                }
                
                if (editBtn) {
                    const txId = editBtn.dataset.txIdEdit;
                    openEditTxDialog(txId);
                }
            });
            
            // Handle Settings form submission
            document.getElementById('settings-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    start_date: document.getElementById('settings-start-date').value,
                    start_balance: parseFloat(document.getElementById('settings-start-balance').value),
                };
                try {
                    await api.post(`${API_URL}/settings`, data);
                    closeModal('settings-modal');
                    fullCalendar.refetchEvents(); // Reload all calendar data
                } catch (e) {
                    console.error("Error saving settings:", e);
                    alert("Error saving: " + e.response?.data?.error || e.message);
                }
            });
            
            // Handle Scheduled Txn Deletion in Settings
            document.getElementById('schedule-list').addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-schedule-id]');
                if (btn) {
                    const scheduleId = btn.dataset.scheduleId;
                    if (confirm("Also delete all future estimated transactions from this schedule?")) {
                        await api.delete(`${API_URL}/schedules/${scheduleId}?delete_future=true`);
                    } else {
                        await api.delete(`${API_URL}/schedules/${scheduleId}?delete_future=false`);
                    }
                    await populateScheduledList(); // Refresh list
                    fullCalendar.refetchEvents(); // Reload calendar
                }
            });

            // Handle Add Category form submission
            document.getElementById('add-category-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    name: document.getElementById('new-cat-name').value,
                    type: document.getElementById('new-cat-type').value,
                };
                if (!data.name) {
                    alert("Please enter a category name.");
                    return;
                }
                try {
                    await api.post(`${API_URL}/categories`, data);
                    document.getElementById('add-category-form').reset();
                    await fetchCategories(); // Refresh the list
                } catch (e) {
                    console.error("Error adding category:", e);
                    alert("Error adding: " + e.response?.data?.error || e.message);
                }
            });

            // Handle Category deletion
            document.getElementById('category-list-manager').addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-cat-id]');
                if (btn) {
                    const catId = btn.dataset.catId;
                    if (confirm("Are you sure? This will remove the category from all transactions, but will not delete the transactions themselves.")) {
                        try {
                            await api.delete(`${API_URL}/categories/${catId}`);
                            await fetchCategories(); // Refresh the list
                        } catch (e) {
                            console.error("Error deleting category:", e);
                            alert("Error deleting: " + e.response?.data?.error || e.message);
                        }
                    }
                }
            });

            // --- CALENDAR INITIALIZATION ---
            function initializeCalendar() {
                fullCalendar = new FullCalendar.Calendar(calendarEl, {
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    initialView: 'dayGridMonth',
                    selectable: true,
                    editable: false,
                    dayMaxEvents: true,
                    
                    // Main data-fetching function
                    events: async (fetchInfo) => {
                        try {
                            const start = fetchInfo.start.toISOString().split('T')[0];
                            const end = fetchInfo.end.toISOString().split('T')[0];
                            const response = await api.get(`${API_URL}/calendar_data?start=${start}&end=${end}`);
                            
                            appSubtitle.innerText = "Your financial data is loaded.";
                            
                            return response.data.map(row => {
                                const balance = row.balance;
                                const credits = row.credits;
                                const debits = row.debits;
                                const is_actual = row.is_actual;
                                
                                const title_style = is_actual ? "font-weight: 600;" : "font-style: italic;";
                                const color = balance < 0 ? "#D32F2F" : "#000000";

                                return {
                                    title: "...", // Placeholder, will be replaced by eventContent
                                    start: row.date,
                                    end: row.date,
                                    allDay: true,
                                    extendedProps: { ...row, 
                                        html: `
                                        <b style='${title_style} color: ${color}; font-size: 1.1em;'>${formatCurrency(balance)}</b><br>
                                        <span style='font-size: 0.9em; color: #1E88E5;'>+${formatCurrency(credits)}</span><br>
                                        <span style='font-size: 0.9em; color: #D32F2F;'>${formatCurrency(debits)}</span>
                                        `
                                    }
                                };
                            });
                        } catch (e) {
                            console.error("Error fetching calendar data:", e);
                            if (e.response && e.response.status === 401) {
                                // Token is bad, log them out
                                logout();
                            }
                            appSubtitle.innerText = "Error loading data. Is the backend server running?";
                            return [];
                        }
                    },
                    
                    // Custom HTML rendering hook
                    eventContent: (arg) => {
                        return { html: arg.event.extendedProps.html };
                    },
                    
                    // Click handler
                    dateClick: (info) => {
                        openDayView(info.dateStr);
                    }
                });

                fullCalendar.render();
            }
            
            function showLoginScreen() {
                loginContainer.style.display = 'block';
                mainAppContainer.style.display = 'none';
            }
            
            async function showAppScreen() {
                // Set the token for all future API requests
                api.defaults.headers.common['Authorization'] = `Bearer ${appState.jwtToken}`;
                
                // Fetch initial data
                try {
                    // Check if token is valid by fetching user info
                    const meResponse = await api.get(`${API_URL}/me`);
                    appSubtitle.innerText = `Welcome, ${meResponse.data.user_id}. Loading data...`;
                    
                    await Promise.all([
                        fetchSettings(),
                        fetchCategories()
                    ]);
                    
                    // Show the app
                    loginContainer.style.display = 'none';
                    mainAppContainer.style.display = 'block';
                    
                    // Initialize and render the calendar
                    initializeCalendar();
                    
                } catch(e) {
                    // Token was bad
                    console.error("Auth token is invalid, logging out.", e);
                    logout();
                }
            }

            // --- INITIAL APP LOAD ---
            function main() {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                if (token) {
                    // New login, save token
                    appState.jwtToken = token;
                    localStorage.setItem('jwtToken', token);
                    // Clean the token from the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    showAppScreen();
                } else {
                    // Check for existing token
                    const storedToken = localStorage.getItem('jwtToken');
                    if (storedToken) {
                        appState.jwtToken = storedToken;
                        showAppScreen();
                    } else {
                        // No token, show login
                        showLoginScreen();
                    }
                }
            }

            main();
        });
    </script>
</body>
</html>
